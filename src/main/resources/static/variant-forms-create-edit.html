<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create/edit variant forms</title>
    <link rel="stylesheet" href="/css/style.css">

    <script src="/js/util.js"></script>
    <script src="/js/variant-forms.js"></script>
    <script src="/js/is-adapted-to-swedish-types.js"></script>
    <script src="/js/normalized-forms.js"></script>
    <script src="/js/adaptation-types.js"></script>
    <script>
    var globVariantFormId = "";
    var addedAdaptationTypes = [];
    const IS_ADAPTED_TO_SWEDISH_NO_VALUE = "NO";
    
    document.addEventListener('DOMContentLoaded', function() {
        init();
    });

    async function init() {
        populateAvailableIsAdaptedToSwedishTypes(await getAllIsAdaptedToSwedishTypesAsync());
        let adapationTypes = await getAllAdaptationTypesAsync();
        populateAvailableAdaptationTypes(adapationTypes._embedded.adaptationTypes);
        let normalizedForms = await getAllNormalizedFormsAsync();
        populateAvailableNormalizedForms(normalizedForms._embedded.normalizedForms);
        let searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has("variantFormId")) {
            setUpForEdit(searchParams.get("variantFormId"));
        } else {
            isAdaptedToSwedishSelected();
            adaptationTypeSelected();
            normalizedFormSelected();
        }
    }
    
    
    function populateAvailableIsAdaptedToSwedishTypes(isAdaptedToSwedishTypes) {
        console.log("isAdaptedToSwedishTypes: " + isAdaptedToSwedishTypes);
        console.log("populateAvailableIsAdaptedToSwedishTypes, no of IsAdaptedToSwedishTypes: " + isAdaptedToSwedishTypes.length);
        let select = document.getElementById("availableIsAdaptedToSwedishTypes");
        for (let i = 0; i < isAdaptedToSwedishTypes.length; i++) {
            select.add(
                new Option(
                    isAdaptedToSwedishTypes[i]
                    , isAdaptedToSwedishTypes[i]));
        }
    }
    
    
    function populateAvailableAdaptationTypes(adapationTypes) {
        console.log("No of adapationTypes: " + adapationTypes.length);
        let selectForAdaptationTypes = document.getElementById("availableAdaptationTypes");
        for (let i = 0; i < adapationTypes.length; i++) {
            selectForAdaptationTypes.add(
                new Option(
                    adapationTypes[i].name
                    , adapationTypes[i]._links.self.href));
        }
    }
    
    function populateAvailableNormalizedForms(normalizedForms) {
        console.log("No of normalized forms: " + normalizedForms.length);
        let selectForNormalizedForms = document.getElementById("availableNormalizedForms");
        for (let i = 0; i < normalizedForms.length; i++) {
            selectForNormalizedForms.add(
                new Option(
                    normalizedForms[i].normalizedForm
                    , normalizedForms[i]._links.self.href));
        }
    }
    

    function setUpForEdit(variantFormId) {
        globVariantFormId = variantFormId;
        console.log("Variant form id to edit " + globVariantFormId);
        loadVariantForm(globVariantFormId);
        document.getElementById("createEditVariantFormHeader").innerHTML = "Editing variant form " + globVariantFormId;
        document.getElementById("createEditButton").value = "Update";
    }

    function loadVariantForm(variantFormId) {
        getVariantFormById(variantFormId, displayVariantForm, handleGetVariantFormError);
    }

    function handleGetVariantFormError(httpErrorStatus) {
        var errorText = "Could not get variant form " + globVariantFormId;
        if (httpErrorStatus == 404) {
            errorText += ", variant form not found";
        } else {
            errorText += " due to status " + httpErrorStatus;
        }
        alert(errorText + ". Setting up for create...");
        setUpForCreate();
    }

    function setUpForCreate() {
        globVariantFormId = "";
		document.getElementById("variantFormName").value = "";
        addedAdaptationTypes.length = 0;
        document.getElementById("addedAdaptationTypes").value = "";
        document.getElementById("availableIsAdaptedToSwedishTypes").selectedIndex = 0;
        isAdaptedToSwedishSelected();
        document.getElementById("availableAdaptationTypes").selectedIndex = 0;
        adaptationTypeSelected();
        document.getElementById("availableNormalizedForms").selectedIndex = 0;
        normalizedFormSelected();
        
        document.getElementById("createEditVariantFormHeader").innerHTML = "Create new variant form";
        document.getElementById("createEditButton").value = "Create";
    }

    function displayVariantForm(variantForm) {
        document.getElementById("variantForm").value = variantForm.variantForm;
        for (let i = 0; i < variantForm.adaptationTypes.length; i++) {
            addAdaptationType(removeTrialingProjection(variantForm.adaptationTypes[i]._links.self.href), variantForm.adaptationTypes[i].name);
        }
        
        let normalizedFormUrl = removeTrialingProjection(variantForm._links.normalizedForm.href);
        genericGet(normalizedFormUrl, function(data) {
            document.getElementById("availableNormalizedForms").value = data._links.self.href;
            normalizedFormSelected();
        });
        
        isAdaptedToSwedishSelected();
        adaptationTypeSelected();
    }

    function variantFormCreatedOrEdited(variantForm) {
        let confirmText =  " variant form " + variantForm.variantForm + " (ID " +  variantForm.variantFormId + "). ";
        if (globVariantFormId === "") {
            confirmText = "Created" + confirmText;
        } else {
            confirmText = "Edited" + confirmText;
        }
        confirmText += " OK to continue editing this variant form, CANCEL to create a new one.";
        if (!confirm(confirmText)) {
            globVariantFormId = "";
            setUpForCreate();
        }
    }
    
    function isAdaptedToSwedishSelected() {
        let selectedIsAdaptedToSwedishType = document.getElementById("availableIsAdaptedToSwedishTypes").value;
        console.log("selectedIsAdaptedToSwedishType: " + selectedIsAdaptedToSwedishType);
        if (selectedIsAdaptedToSwedishType === IS_ADAPTED_TO_SWEDISH_NO_VALUE) {
            disableAndEmptyAddAdaptationTypes();
        } else {
            enableAddAdaptationTypes();
        }
    }
    
    function adaptationTypeSelected() {
        let selectedAdaptationType = document.getElementById("availableAdaptationTypes").value;
        console.log("selectedAdaptationType: " + selectedAdaptationType);
    }
    
    function disableAndEmptyAddAdaptationTypes() {
        console.log("disableAndEmptyAddAdaptationTypes()");
        // empty array
        addedAdaptationTypes.length = 0;
        // empty text box
        document.getElementById("addedAdaptationTypes").value = "";
        
        // Disable label
        document.getElementById("availableAdaptationTypesLabel").classList.remove("for-editable");
        document.getElementById("availableAdaptationTypesLabel").classList.add("disabled");
        // Disable select box and buttons
        document.getElementById("availableAdaptationTypes").disabled = true;
        document.getElementById("addSelectedAdaptationTypeButton").disabled = true;
        document.getElementById("removeSelectedAdaptationTypeButton").disabled = true;
        
    }
    
    function enableAddAdaptationTypes() {
        console.log("enableAddAdaptationTypes()");
        // Enable label
        document.getElementById("availableAdaptationTypesLabel").classList.add("for-editable");
        document.getElementById("availableAdaptationTypesLabel").classList.remove("disabled");
        // Disable select box and buttons
        document.getElementById("availableAdaptationTypes").disabled = false;
        document.getElementById("addSelectedAdaptationTypeButton").disabled = false;
        document.getElementById("removeSelectedAdaptationTypeButton").disabled = false;
    }
    
    function normalizedFormSelected() {
        let selectedNormalizedForm = document.getElementById("availableNormalizedForms").value;
        console.log("selectedNormalizedForm: " + selectedNormalizedForm);
        let id = getIdFromHref(selectedNormalizedForm);
        getNormalizedFormById(id, displayNormalizedForm)
    }
    
    function displayNormalizedForm(normalizedForm) {
        document.getElementById("editSelectedNormalizedForm").href = "/normalized-forms-create-edit.html?normalizedFormId=" + normalizedForm.normalizedFormId;
        document.getElementById("normalizedForm_morphologicalNameType").value = normalizedForm.morphologicalNameType;
        document.getElementById("normalizedForm_morphologicalNameTypeIsShaky").value = normalizedForm.morphologicalNameTypeIsShaky;
        // 2 means that two spaces are used as indention
        document.getElementById("normalizedForm_morphologicalData").value = JSON.stringify(normalizedForm.morphologicalData, (k, v) => v ?? undefined, 2);
        if (normalizedForm.etymology) {
            document.getElementById("normalizedForm_etymology").value = normalizedForm.etymology.languageName;
        } else {
            document.getElementById("normalizedForm_etymology").value = "N/A";
        }
        if (normalizedForm.mediatingLanguage) {
            document.getElementById("normalizedForm_mediatingLanguage").value = normalizedForm.mediatingLanguage.languageName;
        } else {
            document.getElementById("normalizedForm_mediatingLanguage").value = "N/A";
        }
    }
    
    function addSelectedAdaptationType() {
        let availableAdaptationTypesSelect = document.getElementById("availableAdaptationTypes");
        let selectedAdaptationType = availableAdaptationTypesSelect.value;
        let selectedAdaptationTypeText = availableAdaptationTypesSelect.options[availableAdaptationTypesSelect.selectedIndex].text;
        addAdaptationType(selectedAdaptationType, selectedAdaptationTypeText)
    }
    
    function addAdaptationType(adaptationType, adaptationTypeText) {
        console.log("Add " + adaptationType);
        if (!addedAdaptationTypes.includes(adaptationType)) {
            addedAdaptationTypes.push(adaptationType);
            if (addedAdaptationTypes.length === 1) {
                document.getElementById("addedAdaptationTypes").value = adaptationTypeText;
            } else {
                document.getElementById("addedAdaptationTypes").value += "\n" + adaptationTypeText;
            }            
        }
        console.log("addedAdaptationTypes after add: " + addedAdaptationTypes);
    }
    
    function removeSelectedAdaptationType() {
        let availableAdaptationTypesSelect = document.getElementById("availableAdaptationTypes");
        let selectedAdaptationType = availableAdaptationTypesSelect.value;
        let selectedAdaptationTypeText = availableAdaptationTypesSelect.options[availableAdaptationTypesSelect.selectedIndex].text;
        console.log("Remove " + selectedAdaptationType);
        if (addedAdaptationTypes.includes(selectedAdaptationType)) {
            addedAdaptationTypes = addedAdaptationTypes.filter(item => item != selectedAdaptationType);
            if (addedAdaptationTypes.length === 0) {
                document.getElementById("addedAdaptationTypes").value = "";
            } else {
                const rmRegExp = document.getElementById("addedAdaptationTypes").value.startsWith(selectedAdaptationTypeText) ? 
                    new RegExp(selectedAdaptationTypeText + "\n") :
                    new RegExp("\n" + selectedAdaptationTypeText);
                console.log(rmRegExp);
                console.log("Before replace: " + document.getElementById("addedAdaptationTypes").value);
                document.getElementById("addedAdaptationTypes").value = 
                    document.getElementById("addedAdaptationTypes").value.replace(rmRegExp, "");
                console.log("After replace: " + document.getElementById("addedAdaptationTypes").value);
            }            
        }
        console.log("addedAdaptationTypes after remove: " + addedAdaptationTypes);
    }

    </script>
</head>
<body>

<a href="/index.html">Main menu</a>
<br />
<a href="#" class="current-page-in-menu">Create/edit variant forms</a>
<a href="/variant-forms-list.html">List variant forms</a>

<h1 id="createEditVariantFormHeader">Create new variant form</h1>

<form id="createEditVariantFormForm" >
    <p>
        <label for="variantForm" class="for-editable"><b>Variant form:</b></label>
        <input type="text" size="50" id="variantForm"/>
    </p>
    <p>
        <label for="availableIsAdaptedToSwedishTypes" class="for-editable">Is adapted to Swedish:</label>
        <select name="availableIsAdaptedToSwedishTypes" id="availableIsAdaptedToSwedishTypes" onchange="isAdaptedToSwedishSelected()">
        </select>
    </p>
    <fieldset>
        <legend><b><i>Add adaptation types (one or more)</i></b></legend>
        <p>
            <label for="availableAdaptationTypes" class="for-editable" id="availableAdaptationTypesLabel">Adaptation types:</label>
            <select name="availableAdaptationTypes" id="availableAdaptationTypes" onchange="adaptationTypeSelected()">
            </select>
        </p>
        <p>
            <button type="button" onclick="addSelectedAdaptationType()" id="addSelectedAdaptationTypeButton">Add selected adaptation type</button>
            <button type="button" onclick="removeSelectedAdaptationType()" id= "removeSelectedAdaptationTypeButton">Remove selected adaptation type</button>
        </p>
        <p>
            <label for="addedAdaptationTypes" class="disabled">Added adapation types:</label><br/>
            <textarea disabled name="addedAdaptationTypes" form="createEditVariantFormForm" id="addedAdaptationTypes" rows="5" cols="50">
            </textarea>
        </p>
    </fieldset>
    
    <p>
        <label for="availableNormalizedForms" class="for-editable">Normalized form:</label>
        <select name="availableNormalizedForms" id="availableNormalizedForms" onchange="normalizedFormSelected()">
        </select>
    </p>
    <fieldset>
        <legend><b><i>Selected normalized form information</i></b></legend>
        <p>
            <a href="#" id="editSelectedNormalizedForm">Edit selected normalized form</a>
        </p>
        <p>
            <label for="normalizedForm_morphologicalNameType" class="disabled">Morphological name type:</label>
            <input type="text" size="50" id="normalizedForm_morphologicalNameType" disabled/>
        </p>
        <p>
            <label for="normalizedForm_morphologicalNameTypeIsShaky" class="disabled">Morphological name type is shaky:</label>
            <input type="text" size="50" id="normalizedForm_morphologicalNameTypeIsShaky" disabled/>
        </p>
        <p>
            <label for="normalizedForm_morphologicalData" class="disabled">Morphological data:</label><br/>
            <textarea disabled name="normalizedForm_morphologicalData" form="createEditVariantFormForm" id="normalizedForm_morphologicalData" rows="4" cols="50">
            </textarea>
        </p>
        <p>
            <label for="normalizedForm_etymology" class="disabled">Etymology:</label>
            <input type="text" size="50" id="normalizedForm_etymology" disabled/>
        </p>
        <p>
            <label for="normalizedForm_mediatingLanguage" class="disabled">Mediating language:</label>
            <input type="text" size="50" id="normalizedForm_mediatingLanguage" disabled/>
        </p>
    </fieldset>
    
    <input id="createEditButton" type="button" onclick="createOrEditVariantForm(variantFormCreatedOrEdited, globVariantFormId, addedAdaptationTypes)" value="Create">
</form>

</body>
</html>